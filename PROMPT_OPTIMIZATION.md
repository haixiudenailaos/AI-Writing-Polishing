# 系统提示词优化说明

## 调整目标

1. **润色功能**：专注于纯粹的润色优化，不做预测性创作
2. **预测功能**：创造性地预测剧情，复用润色的人设提示词
3. **功能分离**：确保预测功能不干扰润色功能，两者完全独立

## 详细调整内容

### 一、润色功能优化

#### 1. `polish_last_line()` - 基础润色
**调整前**：强调"创造性润色"，可能导致过度改写
**调整后**：
```
【核心任务】
对最后一行文本进行润色优化，保持原意和情节，提升表达质量。

【润色要求】
1. 保持原文的核心意思、情节和人物动作不变
2. 优化用词、句式、节奏，提升文字的流畅度和可读性
3. 修正语法问题和不当表达，让文字更通顺自然
4. 符合上述风格要求，保持文本的整体风格统一
5. 仅做润色优化，不要添加新情节或改变原意
```

#### 2. `polish_last_line_with_kb()` - 知识库增强润色
**调整前**：强调"创造性润色"、"发挥想象力"
**调整后**：
- 大纲资料：从"发挥创意优化表达"改为"优化表达质量"
- 人设资料：从"深化刻画"改为"表达符合人设定位"
- 统一强调"保持原文核心意思、情节和人物动作不变"

#### 3. `batch_polish_document()` - 批量润色
**调整前**：任务描述较简单
**调整后**：
```
【核心任务】
对整个文档进行润色优化，保持原意和情节，提升表达质量。

【润色要求】
1. 保持原文的核心意思、情节结构和段落组织不变
2. 优化用词、句式、节奏，提升文字的流畅度和可读性
3. 修正语法错误和不当表达，让文字更通顺自然
4. 根据用户需求调整文本风格，保持整体风格统一
5. 保持原文的段落格式和换行结构
6. 仅做润色优化，不要添加新情节或改变原意
```

### 二、预测功能优化

#### 1. `predict_plot_continuation()` - 基础剧情预测
**调整前**：任务定位不够明确，权重优先级不清晰
**调整后**：
```
【你的任务】剧情预测与创作
为创作者提供新颖的剧情思路，生成接下来的故事内容。
这不是润色任务，而是创造性的续写和剧情发展。

【核心原则】
🔴 最重要：必须紧密基于用户当前书写的剧情内容来预测
🎭 创意发展：在当前剧情基础上，提供有张力的后续发展
🔗 无缝衔接：预测内容必须直接接续当前文本末尾，不能跳跃

【你的写作风格】
{style_prompt}  # 复用润色的人设提示词

【剧情预测要求（权重排序）】
1. 🔴 紧扣当前剧情：必须基于【当前剧情】的具体情境、人物状态、场景细节
2. 🎭 创意发展：从当前情境出发，选择最有戏剧张力和情感冲击的发展方向
3. ✅ 逻辑合理：确保预测既新颖又符合已建立的逻辑和情境
4. 🎨 风格契合：用符合上述写作风格的语言表达
5. 🔗 无缝衔接：输出必须直接接续当前剧情的末尾，不能跳跃或脱节
```

#### 2. `predict_plot_continuation_with_kb()` - 知识库增强预测
**调整前**：知识库权重过高，可能偏离当前剧情
**调整后**：
```
【你的任务】基于知识库的剧情预测与创作
结合当前上下文和知识库参考资料，生成接下来的故事内容。
这不是润色任务，而是创造性的续写和剧情发展。

【核心原则：权重优先级】
🔴 最高优先级：【当前上下文】- 这是用户正在书写的实际内容，是剧情发展的核心依据
🟡 辅助参考：知识库资料 - 提供背景设定和创意灵感，但必须服从当前上下文

⚠️ 关键要求：
• 当前上下文是最重要的，必须紧密基于它来预测后续剧情
• 知识库资料仅作为辅助，用于理解背景、人设、世界观
• 如果知识库参考与当前上下文冲突，必须以当前上下文为准
• 预测必须无缝接续当前上下文的末尾，不能脱离当前情境

【你的写作风格】
{style_prompt}  # 复用润色的人设提示词

【剧情预测要求（权重排序）】
1. 🔴 紧扣当前上下文：必须基于【当前上下文】的具体情境、人物状态、场景细节来预测
2. 🟡 参考知识库：在理解当前情境的基础上，借鉴知识库中的人设、大纲、历史剧情
3. 🎭 创意发展：从当前情境出发，选择最有戏剧张力和情感冲击的发展方向
4. ✅ 逻辑合理：确保预测既新颖又符合当前已建立的逻辑和情境
5. 🎨 风格契合：用符合上述写作风格的语言表达
6. 🔗 无缝衔接：输出必须直接接续当前上下文的末尾，不能跳跃或脱节

【用户提示词示例】
【预测指令】
🔴 核心依据：请紧密基于【当前上下文】的具体情境来预测后续剧情
🟡 辅助参考：【历史剧情参考】【大纲参考资料】【人设参考资料】可作为背景理解和创意灵感

重要提醒：
• 【当前上下文】是最重要的，预测必须从它出发
• 知识库参考仅作为辅助，不能偏离当前情境
• 如果参考与当前冲突，以当前上下文为准
```

### 三、关键改进点

#### 1. 任务定位明确化
- **润色**：明确标注"润色优化"、"保持原意和情节"
- **预测**：明确标注"剧情预测与创作"、"这不是润色任务"

#### 2. 人设提示词复用
- 润色功能：使用 `【你的润色风格】` 标签
- 预测功能：使用 `【你的写作风格】` 标签
- 两者都复用 `style_prompt` 参数，确保风格统一

#### 3. 功能隔离
- 润色强调：**保持原意**、**不添加新情节**、**仅优化表达**
- 预测强调：**创造性续写**、**剧情发展**、**提供新内容**
- 两个功能在系统提示词层面完全独立，不会互相干扰

#### 4. 权重优先级明确（预测功能）⭐ NEW
- **最高优先级**：用户当前书写的内容（当前上下文）
  - 使用 🔴 红色标记，强调最重要
  - 多次重复"必须基于当前上下文"
  - 明确"预测必须从它出发"
  
- **次要参考**：知识库返回的内容
  - 使用 🟡 黄色标记，表示辅助性质
  - 强调"仅作为辅助"、"不能偏离当前情境"
  - 明确"如果冲突，以当前上下文为准"

- **实现方式**：
  - 系统提示词中设置明确的权重优先级说明
  - 用户提示词中使用视觉标记（🔴/🟡）区分重要性
  - 多次强调"当前上下文是最重要的"

## 使用效果

### 润色功能
- ✅ 专注于优化用词、句式、语法
- ✅ 保持原文情节和人物动作
- ✅ 不会过度改写或添加新内容
- ✅ 符合知识库中的人设和大纲设定

### 预测功能
- ✅ 创造性地发展剧情
- ✅ 提供意想不到的转折
- ✅ 符合人设风格的续写
- ✅ 不会被润色功能的约束限制
- ⭐ **紧密基于用户当前书写的内容**（最高优先级）
- ⭐ **知识库仅作为辅助参考**，不会偏离当前剧情
- ⭐ **即使知识库与当前冲突，也以当前为准**

### 功能独立性
- ✅ 即使用户同时开启预测和润色，两者也不会混淆
- ✅ AI 能清楚识别当前是执行"润色"还是"预测"任务
- ✅ 每个功能都有明确的任务边界
- ⭐ **预测功能不会干扰润色功能**，两者完全独立

## 技术实现

### 代码文件
- `app/api_client.py` - 所有润色和预测相关的 API 调用

### 修改的方法
1. `polish_last_line()` - 第 278-308 行
2. `polish_last_line_with_kb()` - 第 641-702 行
3. `batch_polish_document()` - 第 1200-1225 行
4. `predict_plot_continuation()` - 第 425-451 行
5. `predict_plot_continuation_with_kb()` - 第 1035-1078 行

### 测试建议
1. 测试润色功能是否保持原意（不过度改写）
2. 测试预测功能是否有创造性（不拘泥原文）
3. 测试同时使用两个功能时是否互不干扰
4. 测试人设提示词是否在两个功能中都生效
5. ⭐ **测试预测功能的权重优先级**：
   - 当前剧情与知识库冲突时，是否以当前为准
   - 预测内容是否紧密基于当前书写的内容
   - 知识库是否仅作为辅助，不会主导剧情走向
6. ⭐ **测试边界场景**：
   - 当前剧情明确向A方向发展，知识库暗示B方向，预测应该跟随A
   - 用户写了一个意外转折，预测应该基于这个转折继续，而不是回归知识库的常规路线

## 注意事项

1. **Temperature 差异**
   - 润色：使用默认 temperature (0.2)，确保稳定性
   - 预测：使用较高 temperature (0.85/0.8)，增加创造性

2. **输出格式**
   - 润色：输出一行润色后的文本
   - 预测：输出两行后续剧情

3. **知识库使用**
   - 润色：使用知识库确保符合设定
   - 预测：使用知识库提供创意灵感，但**必须服从当前上下文**

4. ⭐ **权重优先级（预测功能）**
   - **最高权重**：用户当前书写的内容（current_context）
   - **次要权重**：知识库返回的参考内容
   - 系统提示词使用视觉标记（🔴/🟡）明确区分
   - 多次重复强调，确保 AI 理解优先级

5. **功能隔离保证**
   - 润色和预测使用完全独立的系统提示词
   - 两者不会互相影响或混淆
   - 即使同时开启也能正确工作

---

**更新日期**: 2025-11-04
**版本**: v1.1
**主要更新**：
- v1.1 (2025-11-04): 新增预测功能权重优先级明确化，确保当前上下文优先于知识库
- v1.0 (2025-11-04): 初始版本，润色与预测功能分离

